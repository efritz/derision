environment:
  - GO_PACKAGE=github.com/efritz/derision

tasks:
  #
  # Meta Tasks

  import:
    type: docker/import
    files:
      - .

  export:
    type: docker/export
    files:
      - derision

  clean:
    type: convey/clean
    files:
      - derision
      - '**/junit*.xml'

  #
  # Testing

  test:
    type: docker/run
    image: convey/go-test:latest
    command: -cover -sweet.opt "junit.output=junit.xml"

  export-junit:
    type: docker/export
    files:
      - '**/junit*.xml'

  #
  # Building

  build:
    type: docker/run
    image: convey/go-build:latest
    command: -o derision
    environment:
      - GOOS=linux
      - GOARCH=amd64
      - CGO_ENABLED=0

  #
  # Images

  build-image:
    type: docker/build
    dockerfile: Dockerfile
    tag: efritz/derision
    files:
      - derision

plans:
  default:
    stages:
      - name: import
        tasks: import
      - name: test
        tasks:
          - test
          - export-junit
      - name: build
        tasks: build
      - name: export
        tasks: export

  images:
    stages:
      - name: import
        tasks: import
      - name: build
        tasks: build-image

  clean:
    stages:
      - name: clean
        tasks: clean

meta-plans:
  everything:
    plans:
      - default
      - images
